# @package _global_

# to execute this experiment run:
# python train.py +experiment=train_GATsSPG

defaults:
    - override /trainer: null  # override trainer to null so it's not loaded from main config defaults...
    - override /model: null
    - override /datamodule: null
    - override /callbacks: null
    - override /logger: null

# we override default configurations with nulls to prevent them from loading at all
# instead we define all modules and their paths directly in this config,
# so everything is stored in one place for more readibility

seed: 12345

task_name: onepose
exp_name: train_onepose
scan_data_dir: ${data_dir}/onepose_datasets/test_data
trainer:
    _target_: lightning.pytorch.Trainer
#    devices: -1
    devices: [0]
    min_epochs: 1
    max_epochs: 25
#    max_steps: 250000
    gradient_clip_val: 0.5
    accumulate_grad_batches: 2
    num_sanity_val_steps: 0
    limit_val_batches: 0
#    limit_train_batches: 10
    benchmark: True
    enable_checkpointing: False
#    strategy: ddp_find_unused_parameters_true

model:
    # _target_: src.models.spg_model.LitModelSPG
    _target_: src.models.Pose_lightning_model.LitModelPose
    optimizer: adam
    lr: 1e-3
    weight_decay: 0.
    architecture: SuperGlue

    milestones: [5, 10, 15, 20]
    gamma: 0.5

    descriptor_dim: 128
    keypoints_encoder: [32, 64, 128]
    sinkhorn_iterations: 100
    match_threshold: 0.2
    match_type: 'softmax'
    scale_factor: 0.07

    # focal loss
    focal_loss_alpha: 0.5
    focal_loss_gamma: 2
    pos_weights: 0.5
    neg_weights: 0.5

    # GATs
    include_self: True
    with_linear_transform: False
    additional: False

    # SuperPoint
    spp_model_path: ${work_dir}/data/models/extractors/SuperPoint/superpoint_v1.pth

    # ResNet
    resnet_path: ${work_dir}/data/pretrained_resnet/resnet34-333f7ec4.pth

    # NeRF rendering
    N_samples: 128
    feat_dim: 128
    num_source_views: 10
    inv_uniform: True
    white_bkgd: False
    N_rand: 3500

    # NeRF Prerained weight
    nerf_weight: ${work_dir}/data/models/checkpoints/onepose_plus_train/nerf_v1.ckpt
    # trainer:
        # n_val_pairs_to_plot: 5
    # Logging frequency
    log_img_step: 2000
    log_scalar_step: 100

    # Transformer Params
    head_dim: 128
    n_head: 1
    dustbin: False
    vis_layer: False
    encoder_layers: 4
    decoder_layers: 4

    # Losses
    pose_supervision: True
    pose_scaling: 1e-3
    pose_epoch: 15
    use_mc_loss: False
    # Eval result output
    checkpoint_dir: ${work_dir}/data/models/checkpoints/onepose_plus_train/pose.ckpt
    test: True
    eval_dir: ${work_dir}/eval_result

datamodule:
    _target_: src.datamodules.pose_datamodule.PoseDataModule
    data_dirs: ${data_dir}/sfm_model
    dataset_dirs: ${data_dir}/onepose_datasets
    anno_dirs: outputs_${model.match_type}/anno
    train_anno_file: ${work_dir}/data/cache/${task_name}/train.json
    val_anno_file: ${work_dir}/data/cache/${task_name}/val.json
    test_anno_file: ${work_dir}/data/cache/${task_name}/test.json
    batch_size: 4
    num_workers: 0
    num_leaf: 8
    pin_memory: True
    shape2d: 1000
    shape3d: 2000
    assign_pad_val: 0
    load_in_ram: True
    # NeRF params
    num_source_views: 10
    num_total_views: 30
    resolution: 128
    sample_resolution: 64
    # Voxel sampling params
    voxel_samples: 200
    image_samples: 50
    crd_samples: 50
    sigma: 1
    query_dir:
      - ${scan_data_dir}/0410-huiyuan-box huiyuan-3
#      - ${scan_data_dir}/0408-colorbox-box colorbox-4
#      - ${scan_data_dir}/0409-aptamil-box aptamil-3
#      - ${scan_data_dir}/0419-cookies2-others cookies2-4
#      - ${scan_data_dir}/0422-qvduoduo-box qvduoduo-4
#      - ${scan_data_dir}/0423-oreo-box oreo-4
#      - ${scan_data_dir}/0424-chocbox-box chocbox-4
#      - ${scan_data_dir}/0447-nabati-box nabati-5
#      - ${scan_data_dir}/0450-hlychocpie-box hlychocpie-4
#      - ${scan_data_dir}/0452-hlymatchapie-box hlymatchapie-4
#      - ${scan_data_dir}/0455-strawberryoreo-box strawberryoreo-4
#      - ${scan_data_dir}/0456-chocoreo-box chocoreo-4
#      - ${scan_data_dir}/0458-hetaocakes-box hetaocakes-4
#      - ${scan_data_dir}/0459-jzhg-box jzhg-4
#      - ${scan_data_dir}/0466-mfmilkcake-box mfmilkcake-4
#      - ${scan_data_dir}/0468-minipuff-box minipuff-4
#      - ${scan_data_dir}/0469-diycookies-box diycookies-4
#      - ${scan_data_dir}/0470-eggrolls-box eggrolls-4
#      - ${scan_data_dir}/0471-hlyormosiapie-box hlyormosiapie-4
#      - ${scan_data_dir}/0472-chocoreo-bottle chocoreo-4
#      - ${scan_data_dir}/0473-twgrassjelly1-box twgrassjelly1-4
#      - ${scan_data_dir}/0474-twgrassjelly2-box twgrassjelly2-4
#      - ${scan_data_dir}/0476-giraffecup-bottle giraffecup-4
#      - ${scan_data_dir}/0480-ljcleaner-others ljcleaner-4
#      - ${scan_data_dir}/0483-ambrosial-box ambrosial-4
#      - ${scan_data_dir}/0486-sanqitoothpaste-box sanqitoothpaste-4
#      - ${scan_data_dir}/0487-jindiantoothpaste-box jindiantoothpaste-4
#      - ${scan_data_dir}/0488-jijiantoothpaste-box jijiantoothpaste-4
#      - ${scan_data_dir}/0489-taipingcookies-others taipingcookies-4
#      - ${scan_data_dir}/0490-haochidiancookies-others haochidiancookies-4
#      - ${scan_data_dir}/0492-tuccookies-box tuccookies-4
#      - ${scan_data_dir}/0493-haochidianeggroll-box haochidianeggroll-4
#      - ${scan_data_dir}/0494-qvduoduocookies-box qvduoduocookies-4
#      - ${scan_data_dir}/0495-fulingstapler-box fulingstapler-4
#      - ${scan_data_dir}/0496-delistapler-box delistapler-4
#      - ${scan_data_dir}/0497-delistaplerlarger-box delistaplerlarger-4
#      - ${scan_data_dir}/0498-yousuanru-box yousuanru-4
#      - ${scan_data_dir}/0500-chocfranzzi-box chocfranzzi-4
#      - ${scan_data_dir}/0501-matchafranzzi-box matchafranzzi-4
#      - ${scan_data_dir}/0502-shufujia-box shufujia-5
#      - ${scan_data_dir}/0503-shufujiawhite-box shufujiawhite-3
#      - ${scan_data_dir}/0504-lux-box lux-4
#      - ${scan_data_dir}/0508-yqsl-others yqsl-4
#      - ${scan_data_dir}/0510-yqslmilk-others yqslmilk-4
#      - ${scan_data_dir}/0511-policecar-others policecar-4
#      - ${scan_data_dir}/0517-nationalgeo-box nationalgeo-4
#      - ${scan_data_dir}/0518-jasmine-box jasmine-4
#      - ${scan_data_dir}/0519-backpack1-box backpack1-4
#      - ${scan_data_dir}/0520-lipault-box lipault-4
#      - ${scan_data_dir}/0521-ranova-box ranova-4
#      - ${scan_data_dir}/0522-milkbox-box milkbox-4
#      - ${scan_data_dir}/0523-edibleoil-others edibleoil-4
#      - ${scan_data_dir}/0525-toygrab-others toygrab-2
#      - ${scan_data_dir}/0526-toytable-others toytable-3
#      - ${scan_data_dir}/0527-spalding-others spalding-2
#      - ${scan_data_dir}/0534-tonkotsuramen-box tonkotsuramen-4
#      - ${scan_data_dir}/0535-odbmilk-box odbmilk-4
#      - ${scan_data_dir}/0537-petsnack-box petsnack-4
#      - ${scan_data_dir}/0539-spamwrapper-others spamwrapper-5
#      - ${scan_data_dir}/0543-brownhouse-others brownhouse-4
#      - ${scan_data_dir}/0547-cubebox-box cubebox-4
#      - ${scan_data_dir}/0548-duck-others duck-4
#      - ${scan_data_dir}/0550-greenbox-box greenbox-4
#      - ${scan_data_dir}/0551-milk-others milk-4
#      - ${scan_data_dir}/0552-mushroom-others mushroom-4
#      - ${scan_data_dir}/0557-santachoc-others santachoc-4
#      - ${scan_data_dir}/0558-teddychoc-others teddychoc-4
#      - ${scan_data_dir}/0559-tissuebox-box tissuebox-4
#      - ${scan_data_dir}/0560-tofubox-box tofubox-4
#      - ${scan_data_dir}/0564-biatee-others biatee-4
#      - ${scan_data_dir}/0565-biscuits-box biscuits-4
#      - ${scan_data_dir}/0568-cornflakes-box cornflakes-5
#      - ${scan_data_dir}/0570-kasekuchen-box kasekuchen-4
#      - ${scan_data_dir}/0577-schoko-box schoko-4
#      - ${scan_data_dir}/0578-tee-others tee-4
#      - ${scan_data_dir}/0579-tomatocan-bottle tomatocan-4
#      - ${scan_data_dir}/0580-xmaxbox-others xmaxbox-4
#      - ${scan_data_dir}/0582-yogurtlarge-others yogurtlarge-4
#      - ${scan_data_dir}/0583-yogurtmedium-others yogurtmedium-4
#      - ${scan_data_dir}/0594-martinBootsLeft-others martinBootsLeft-2
#      - ${scan_data_dir}/0595-martinBootsRight-others martinBootsRight-4

#callbacks:
#    model_checkpoint:
#        _target_: lightning.pytorch.callbacks.ModelCheckpoint
#        monitor: "val/loss"
#        save_top_k: -1
#        save_last: True
#        mode: "min"
#        dirpath: '${data_dir}/models/checkpoints/${exp_name}'
#        filename: '{epoch}'
#    lr_monitor:
#        _target_: lightning.pytorch.callbacks.LearningRateMonitor
#        logging_interval: 'step'

logger:
    tensorboard:
        _target_: lightning.pytorch.loggers.TensorBoardLogger
        save_dir: '${data_dir}/logs'
        name: ${exp_name}
        default_hp_metric: False

#    neptune:
#        tags: ["best_model"]
#    csv_logger:
#        save_dir: "."

hydra:
    run:
      dir: ${work_dir}